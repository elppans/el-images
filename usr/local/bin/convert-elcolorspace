#!/bin/bash

# Função para exibir a ajuda
function show_help {
    echo "Uso: $0 [opções] [espaço de cores] [diretório ou arquivos]"
    echo "Opções:"
    echo "  -o, --output-dir   Diretório para salvar as imagens convertidas (padrão: convertido/ no diretório atual)"
    echo "  -h, --help         Exibe esta ajuda"
    echo
    echo "Espaços de cores suportados:"
    echo "  rgb, cmyk, gray, lab, ycbcr"
    echo
    echo "Exemplo:"
    echo "  $0 gray -o /meu/diretorio/ /caminho/imagens/"
}

# Definição de valores padrão
output_dir="./convertido"

# Exibe os argumentos recebidos para depuração
echo "Argumentos recebidos: $@" >> /tmp/convert-elcolorspace-debug.log

# Parsing das opções
while [[ "$1" =~ ^- && ! "$1" == "--" ]]; do 
    case $1 in
        -o | --output-dir )
            shift
            output_dir="$1"
            echo "Diretório de saída definido: $output_dir" >> /tmp/convert-elcolorspace-debug.log
            ;;
        -h | --help )
            show_help
            exit 0
            ;;
        *)
            echo "Opção desconhecida: $1" >> /tmp/convert-elcolorspace-debug.log
            show_help
            exit 1
            ;;
    esac
    shift
done

# Verifica se o espaço de cores foi fornecido
if [ -z "$1" ]; then
    echo "Erro: Nenhum espaço de cores especificado." >> /tmp/convert-elcolorspace-debug.log
    show_help
    exit 1
fi

color_space="$1"
shift  # Remove o argumento do espaço de cores

# Verifica se há arquivos ou diretórios fornecidos
if [ -z "$1" ]; then
    echo "Erro: Nenhum diretório ou arquivo especificado." >> /tmp/convert-elcolorspace-debug.log
    show_help
    exit 1
fi

# Criar o diretório de saída caso não exista
mkdir -p "$output_dir"
echo "Criado ou verificado diretório de saída: $output_dir" >> /tmp/convert-elcolorspace-debug.log

# Se for um diretório, pega todas as imagens dentro dele
if [ -d "$1" ]; then
    files=("$1"/*)
else
    files=("$@")
fi

# Verifica se há arquivos válidos
if [ ${#files[@]} -eq 0 ]; then
    echo "Erro: Nenhuma imagem encontrada." >> /tmp/convert-elcolorspace-debug.log
    exit 1
fi

# Mapeamento do espaço de cores
case "$color_space" in
    rgb) convert_space="sRGB" ;;
    cmyk) convert_space="CMYK" ;;
    gray) convert_space="Gray" ;;
    lab) convert_space="Lab" ;;
    ycbcr) convert_space="YCbCr" ;;
    *) 
        echo "Erro: Espaço de cores inválido." >> /tmp/convert-elcolorspace-debug.log
        show_help
        exit 1
        ;;
esac

# Processamento das imagens
for file in "${files[@]}"; do
    if [[ -f "$file" ]]; then
        filename=$(basename "$file")
        output_file="$output_dir/$filename"
        
        echo "Convertendo: $file -> $output_file ($convert_space)" >> /tmp/convert-elcolorspace-debug.log
        
        convert "$file" -colorspace "$convert_space" "$output_file"

        if [ $? -eq 0 ]; then
            echo "SUCESSO: $output_file" >> /tmp/convert-elcolorspace-debug.log
        else
            echo "ERRO ao converter: $file" >> /tmp/convert-elcolorspace-debug.log
        fi
    fi
done

echo "Conversão concluída. Arquivos salvos em: $output_dir" >> /tmp/convert-elcolorspace-debug.log
